<!DOCTYPE html>

<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <title>Comparing World Happiness</title>
    <meta name="author" content="Raza Anees">

    <link rel="stylesheet" href="css/main.css">
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
</head>

<body onload="main()">

    <header>
        <h1>Changes in World Happiness</h1>

        <div class="description">
            <p>
                The Sustainable Development Solutions Network (SDSN) creates
                "Happiness Scores" based on six factors: GDP per capita, Social
                support, Generosity, Freedom, Trust in Government, and Health. The
                Slopegraph below shows how those Happiness Scores have changed from
                2015 to 2017.<br><br>
                The year 2016 can be filtered by clicking on the "2016" button
                below. Countries can also be filtered by clicking on their names
                or hovering over their labels below.

            </p>
        </div>

        <ul class="legend">
            <li><span class="increase_10"></span>Happiness Increase > 10%</li>
            <li><span class="no_change"></span>No major change</li>
            <li><span class="decrease_10"></span>Happiness Decrease > 10%</li>
        </ul>
        <nav id='year-filter'></nav>
        <nav id='country-filter'></nav>
        <div class="buffer"></div>
    </header>

    <section id='slopegraph' class='slope'></section>

    <!-- ****************** start d3 code ****************** -->
    <!-- main.js script -->
    <script src="js/main.js"></script>

    <script>
    // render slopgraph chart

    function main() {
        'use strict';

        // load the data
            // years to be shown from the data
        var data,
        keyValues = ['2015', '2016', '2017'];

        // store chart
        var slopegraph;
        // track user interaction
        var state = {
            // mutate array
            keys: keyValues,
            // track filtered sets
            filter: [],
            // toggle specific countries
            navToggle: [],
            // track line selection
            highlight: []
        };

        d3.json('data/data.json', function(error, dd) {
            if (error) throw error;
            dd.forEach(function(d) {
                d["2015"] = +d["2015"];
                d["2016"] = +d["2016"];
                d["2017"] = +d["2017"];
            });
            // reference data outside of this initialization
            data = dd;
            // initial render of chart
            render(data, keyValues);
            // navigation
            filterCountry(data);
            // filtering options
            filterYear();
        });

        // filter based on user interaction
        function filterYear() {
            // create array values
            keyValues.forEach(function(n) {
                state["filter"].push(false);
            });
            d3.select('nav#year-filter').append('ul')
                .selectAll('li')
                .data(keyValues)
                .enter()
                .append('li')
                .on('click', function(d, i) {
                    // if a year was clicked when it was already toggled off
                    if (state.filter[i]) {
                        // toggle
                        state.filter[i] = false;
                        d3.select(this).style('opacity', 1);
                        // add year to array
                        state.keys.push(d);
                        // keep array in chronological order
                        state.keys.sort();
                        // render with new keys
                        render(data, state.keys);
                    }
                    // Disable the clicked year if
                    // at least two values are selected
                    else if (!state.filter[i] && state.keys.length > 2) {
                        state.filter[i] = true;
                        d3.select(this).style('opacity', 0.3);
                        state.keys.splice(i, 1);
                        state.keys.sort();
                        render(data, state.keys);
                    }
                })
                .text(function(d) {return d;});
        }

        // highlight lines based on user interaction
        function filterCountry(data) {
            data.forEach(function(n) {
                state.navToggle.push(false);
            });

            d3.select('nav#country-filter')
                .append('ul')
                .selectAll('li')
                .data(data)
                .enter()
                .append('li')
                .attr('class', function(d, i) {return 'navAlt li-'+i;})
                .on('click', function(d, i) {
                    // if the country has already been clicked and filtered out
                    if (state.navToggle[i] || state.highlight === i) {
                        state.navToggle[i] = false;
                        var index = state.highlight.indexOf(i)
                        state.highlight.splice(index, 1);
                        if (state.highlight.length === 0) {
                            resetSelection();
                        } else {
                            highlightLine(state.highlight);
                            highlightNav(state.highlight);
                            highlightLabel(state.highlight);
                        }
                    }
                    else if (!state.navToggle[i]) {
                        state.navToggle[i] = true;
                        state.highlight.push(i);
                        // highlight the selected line
                        highlightLine(state.highlight);
                        // highlight the navigation button related to the line
                        highlightNav(state.highlight);
                        // highlight the country name and happiness score
                        highlightLabel(state.highlight);
                        // reflect highlighted line in state
                    }
                })
                .text(function(d) {return d["country"];});
        }

        // render the slopegraph
        function render(data, keys) {
            resetSelection();
            // create chart

            slopegraph = slopey()
                .w(350)

                .margin({top: 30, bottom: 20, left: 140, right: 140})
                .gutter(25)
                .keyName('country')
                .keyValues(keys)
                .on('_hover', function(d, i) {
                    state.highlight = [i];
                    // highlight line based on hovered cursor
                    highlightLine(state.highlight);
                    // highlight navigation pane related to highlighted line
                    highlightNav(state.highlight);
                    highlightLabel(state.highlight);
                })
                .on('_moveaway',function(d, i) {
                    resetSelection();
                    state.highlight = [];
                });

            // apply chart
            d3.select('section.slope')
                .datum(data)
                .call(slopegraph);

            // ensure highlight is maintained when graph is updated
            if (state.highlight.length > 0) {
                d3.selectAll('.elm').style('opacity', 0.2).style('stroke-width', 1);
                highlightNav(state.highlight);
                highlightLabel(state.highlight);
                highlightLine(state.highlight);
            }
        }

        // highlight the selected line
        function highlightLine(highlight) {
            d3.selectAll('.elm')
            .transition()
            .style('opacity', 0.2)
            .style('stroke-width', 1);

            var n = highlight.length;
            for (var i = 0; i < n; i++) {
                d3.selectAll('.sel-'+highlight[i]).transition()
                .style('opacity', 1).style('stroke-width', 2);
            }
        }

        // highlight the corresponding country in the navigation pane
        function highlightNav(highlight) {
            d3.selectAll('.navAlt').transition().style('opacity', 0.2);

            var n = highlight.length;
            for (var i = 0; i < n; i++) {
                d3.selectAll('.li-' + highlight[i]).transition().style('opacity', 1);
            }
        }


        // enlarge labels of selected country
        function highlightLabel(highlight) {
            d3.selectAll('.labels').transition().style('opacity', 0.2)
            .style('font-size', "9.5px");

            highlight.forEach(function(d) {
                d3.selectAll('.lab-'+d).transition().style('opacity', 1)
                .style('font-size', "12px");
            })
        }

        // reset the chart and clear any selections
        function resetSelection() {
            d3.selectAll('.elm').transition().style('opacity', 1).style('stroke-width', 1);
            d3.selectAll('.navAlt').transition().style('opacity', 1);
            d3.selectAll('.labels').style('font-size', "9.5px");
        }

        d3.select('.buffer')
        .on('mouseover', function() {
            resetSelection();
            state.highlight = [];
        })
    };
    </script>
</body>
</html>
